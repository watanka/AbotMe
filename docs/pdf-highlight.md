# PDF 하이라이트 설계 가이드

이 문서는 PDF 내 특정 텍스트/항목을 웹에서 정확하게 하이라이트하기 위한 설계 원칙과 실무적 권장 방식을 정리합니다.

---

## 1. 하이라이트 방식 비교

### (1) 위치(bbox) 기반 하이라이트
- 각 텍스트 블록의 PDF 내 좌표(bbox: x1, y1, x2, y2) 정보를 저장
- 하이라이트 시 PDF 뷰어에 오버레이로 표시
- **장점:**
  - PDF.js 등에서 바로 시각적 오버레이 가능
  - 원본 PDF와 1:1 위치 매칭
- **단점:**
  - 화면 크기, 폰트, DPI, 줌 등 렌더링 환경에 따라 정확도가 달라질 수 있음
  - PDF.js의 텍스트 레이어와 bbox 매칭이 까다로울 수 있음

### (2) 라벨(anchor/id) 기반 하이라이트
- 각 텍스트/문단/블록에 고유 라벨(id, anchor 등)을 부여
- 하이라이트 시 해당 라벨값으로 PDF 뷰어에서 직접 매칭
- **장점:**
  - 폰트/화면크기/디바이스에 상관없이 정확한 매칭
  - 논리적 블록 단위로 하이라이트, UI/UX 일관성
- **단점:**
  - PDF.js 등에서 각 블록에 라벨을 부여하는 커스텀 로직 필요
  - 라벨 설계/매칭이 꼼꼼해야 함

---

## 2. 실무적 권장안

- **라벨 기반(anchor/id)** 방식이 장기적으로 더 견고하고 UI/UX/확장성에 유리
- PDF 추출 시 각 문단/문장/블록에 고유 id(block_id 등) 부여
- 벡터스토어/LLM에도 block_id와 텍스트를 함께 저장
- 하이라이트 요청 시 `{ block_id: "block-23", ... }` 등으로 반환
- PDF.js 커스텀 텍스트 레이어에 `data-block-id` 등으로 라벨 부여, 하이라이트
- 필요시 bbox(좌표)도 함께 저장해 fallback 용도로 활용 가능

---

## 3. 예시 데이터 구조

### (1) 추출/저장 예시
```json
{
  "block_id": "block-23",
  "page": 2,
  "text": "이 프로젝트에서 가장 어려웠던 점은...",
  "bbox": [120, 340, 480, 370]
}
```

### (2) 하이라이트 API 응답 예시
```json
{
  "answer": "협업에서 가장 어려웠던 점은...",
  "highlights": [
    { "block_id": "block-23", "page": 2 }
  ]
}
```

---

## 4. PDF.js 커스텀 하이라이트 구현

- 텍스트 레이어 생성 시 각 블록에 `data-block-id` 속성 부여
- 하이라이트할 block_id와 일치하는 DOM에 Tailwind 등으로 배경색 오버레이
- 예시:
```js
// PDF.js 텍스트 레이어 렌더링 시
<span data-block-id="block-23"> ... </span>

// 하이라이트
const highlightId = "block-23";
document.querySelectorAll(`[data-block-id="${highlightId}"]`).forEach(el => {
  el.classList.add("bg-yellow-200", "rounded", "px-1");
});
```

---

## 5. 혼합 방식
- 라벨 기반을 메인으로, bbox(좌표)도 함께 저장해 UI/뷰어 환경에 따라 fallback 가능

---

## 6. 주의사항
- PDF 원본이 변경되면 block_id 불일치 가능 (버전 관리 필요)
- 추출/벡터스토어/뷰어 모두 동일한 block_id 체계 사용

---

## 7. 결론
- **라벨 기반 하이라이트가 가장 견고하고, UI/UX와 확장성 모두에 유리**
- block_id 중심으로 전체 파이프라인(추출-검색-하이라이트)을 설계할 것
